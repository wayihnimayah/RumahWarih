<script>
    function calculateDerivative() {
      const input = document.getElementById('functionInput').value;
      try {
        const result = math.derivative(input, 'x').toString();
        document.getElementById('derivativeResult').innerHTML = `Turunan dari f(x): <strong>${result}</strong>`;
        MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
      } catch {
        document.getElementById('derivativeResult').innerText = "Error pada input.";
      }
    }

    function calculateIntegral() {
      const input = document.getElementById('integralInput').value;
      try {
        const result = math.integral(input, 'x').toString();
        document.getElementById('integralResult').innerHTML = `Integral dari f(x): <strong>${result}</strong> + C`;
        MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
      } catch {
        document.getElementById('integralResult').innerText = "Error pada input.";
      }
    }

    function calculateLimit() {
      const expr = document.getElementById('limitFunctionInput').value;
      const x = parseFloat(document.getElementById('limitValueInput').value);
      try {
        const compiled = math.parse(expr).compile();
        const left = compiled.evaluate({ x: x - 0.00001 });
        const right = compiled.evaluate({ x: x + 0.00001 });
        const avg = ((left + right) / 2).toFixed(5);
        document.getElementById('limitResult').innerHTML = `Limit saat x → ${x}: <strong>${avg}</strong>`;
        MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
      } catch {
        document.getElementById('limitResult').innerText = "Input tidak valid.";
      }
    }

    const quizBank = [
      {
        topic: "turunan",
        question: "Turunan dari \\( f(x) = x^2 \\) adalah ...",
        options: [
          { label: "A", text: "\\( 2x \\)", correct: true },
          { label: "B", text: "\\( x^2 \\)", correct: false }
        ],
        explanation: "Turunan dari \\( x^n \\) adalah \\( nx^{n-1} \\), jadi \\( f'(x) = 2x \\)."
      },
      {
        topic: "integral",
        question: "Integral dari \\( f(x) = 3x^2 \\) adalah ...",
        options: [
          { label: "A", text: "\\( x^3 + C \\)", correct: true },
          { label: "B", text: "\\( 3x + C \\)", correct: false }
        ],
        explanation: "Integral dari \\( x^n \\) adalah \\( \\frac{x^{n+1}}{n+1} + C \\), jadi hasilnya \\( x^3 + C \\)."
      },
      {
        topic: "limit",
        question: "Limit dari \\( \\frac{x^2 - 1}{x - 1} \\) saat \\( x \\to 1 \\) adalah ...",
        options: [
          { label: "A", text: "2", correct: true },
          { label: "B", text: "Tak terdefinisi", correct: false }
        ],
        explanation: "Faktorkan: \\( \\frac{(x - 1)(x + 1)}{x - 1} \\), coret \\( x - 1 \\), sisa \\( x + 1 = 2 \\)."
      }
    ];

    function generateRandomQuestion() {
      const topic = document.getElementById("topicSelect").value;
      const filtered = topic === "semua" ? quizBank : quizBank.filter(q => q.topic === topic);
      if (filtered.length === 0) return;
      const quiz = filtered[Math.floor(Math.random() * filtered.length)];
      document.getElementById("randomQuestion").innerHTML = quiz.question;
      const optDiv = document.getElementById("randomOptions");
      optDiv.innerHTML = "";
      quiz.options.forEach((opt, i) => {
        optDiv.innerHTML += `<div class="option">
          <input type="radio" name="randomQ" id="opt${i}" value="${opt.label}">
          <label for="opt${i}">${opt.label}) ${opt.text}</label>
        </div>`;
      });
      const result = document.getElementById("randomResult");
      result.innerHTML = "";
      result.style.display = "none";
      const btn = document.createElement("button");
      btn.textContent = "Cek Jawaban";
      btn.onclick = () => {
        const selected = document.querySelector('input[name="randomQ"]:checked');
        const correct = quiz.options.find(opt => opt.correct).label;
        if (!selected) return;
        const isCorrect = selected.value === correct;
        result.innerHTML = `${isCorrect ? "✅ Benar!" : "❌ Salah."}<br><em>Penjelasan:</em> ${quiz.explanation}`;
        result.style.display = "block";
        MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
      };
      optDiv.appendChild(btn);
      MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
    }
